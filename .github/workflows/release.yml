name: Release Plugin

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests and validation
      run: |
        npm run type-check
        npm run lint
        npm run build
        npm run validate-plugin-structure

    - name: Create plugin package
      run: |
        echo "Creating plugin package..."

        # Create a temporary directory for the package
        PKG_DIR="orca-link-icons-plugin"
        mkdir -p "$PKG_DIR"

        # Copy required files
        cp -r dist "$PKG_DIR/"
        cp icon.png "$PKG_DIR/"
        cp README.md "$PKG_DIR/" 2>/dev/null || echo "README.md not found, skipping"

        # Create package.json for distribution (minimal)
        cat > "$PKG_DIR/package.json" << EOF
        {
          "name": "orca-link-icons-plugin",
          "version": "$(node -p "require('./package.json').version")",
          "description": "$(node -p "require('./package.json').description")",
          "main": "dist/index.js",
          "orca": $(node -p "JSON.stringify(require('./package.json').orca)")
        }
        EOF

        # Create plugin info file
        cat > "$PKG_DIR/plugin-info.json" << EOF
        {
          "name": "orca-link-icons-plugin",
          "version": "$(node -p "require('./package.json').version")",
          "displayName": "$(node -p "require('./package.json').orca.displayName")",
          "description": "$(node -p "require('./package.json').orca.description")",
          "author": "$(node -p "require('./package.json').author")",
          "buildDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "gitCommit": "${{ github.sha }}",
          "gitTag": "${{ github.ref_name }}"
        }
        EOF

        # Create zip file
        zip -r "orca-link-icons-plugin-${{ github.ref_name }}.zip" "$PKG_DIR"

        echo "Plugin package created successfully"

    - name: Generate changelog
      id: changelog
      run: |
        # Get previous tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -n "$PREVIOUS_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
        else
          CHANGELOG=$(git log --pretty=format:"- %s (%h)")
        fi

        # Save changelog to file
        echo "$CHANGELOG" > CHANGELOG.md

        # Set output for GitHub release
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          orca-link-icons-plugin-${{ github.ref_name }}.zip
          dist/index.js
        body: |
          ## ğŸš€ Orca Link Icons Plugin ${{ github.ref_name }}

          è‡ªåŠ¨å°†é“¾æ¥ä¸­çš„é»˜è®¤åœ°çƒå›¾æ ‡æ›¿æ¢ä¸ºçœŸå®ç½‘ç«™å›¾æ ‡ï¼Œæ”¯æŒå¤šæºè·å–å’Œæœ¬åœ°ç¼“å­˜ã€‚

          ### âœ¨ æ–°ç‰¹æ€§
          ${{ steps.changelog.outputs.changelog }}

          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ `orca-link-icons-plugin-${{ github.ref_name }}.zip`
          2. è§£å‹åˆ° Orca çš„ `plugins` ç›®å½•
          3. é‡å¯ Orca å¹¶åœ¨æ’ä»¶è®¾ç½®ä¸­å¯ç”¨

          ### ğŸ”§ é…ç½®é€‰é¡¹
          æ”¯æŒé€šè¿‡æ§åˆ¶å° API è¿›è¡Œé«˜çº§é…ç½®ï¼š
          ```javascript
          // æŸ¥çœ‹æ’ä»¶çŠ¶æ€
          window.__ORCA_ICON_REPLACER.getStats()

          // æ¸…é™¤ç¼“å­˜
          window.__ORCA_ICON_REPLACER.clearCache()

          // é‡å¯æ’ä»¶
          window.__ORCA_ICON_REPLACER.restart()
          ```

          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/SaXz2/orca-link-icons-plugin/issues) ä¸­åé¦ˆã€‚
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update package.json version
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        # Extract version from tag (remove 'v' prefix)
        VERSION="${{ github.ref_name }}"
        VERSION="${VERSION#v}"

        # Update version in package.json
        npm version $VERSION --no-git-tag-version --allow-same-version

        echo "Updated package.json version to $VERSION"

    - name: Commit version update
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add package.json
        git diff --staged --quiet || git commit -m "chore: update version to ${{ github.ref_name }} [skip ci]"
        git push

  notify:
    runs-on: ubuntu-latest
    needs: release
    if: always()

    steps:
    - name: Notify release status
      if: needs.release.result == 'success'
      run: |
        echo "âœ… Plugin ${{ github.ref_name }} released successfully!"
        echo "ğŸ“¦ Download: https://github.com/SaXz2/orca-link-icons-plugin/releases/tag/${{ github.ref_name }}"

    - name: Notify release failure
      if: needs.release.result == 'failure'
      run: |
        echo "âŒ Plugin release failed for ${{ github.ref_name }}"
        exit 1